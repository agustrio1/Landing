---
// src/components/FloatingWhatsApp.astro
---

<div id="floating-whatsapp">
  <a href="#" id="wa-button">
    <i class="fab fa-whatsapp wa-icon"></i>
    <span class="wa-text">Chat WhatsApp</span>
  </a>

  <div class="notification-badge">
    <i class="fas fa-exclamation"></i>
  </div>

  <!-- Chat Bubble -->
  <div class="chat-bubble" id="chat-bubble">
    <div class="chat-header">
      <div class="chat-info">
        <div class="chat-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div class="chat-details">
          <h4>Trio Agus</h4>
          <div class="chat-status" id="chat-status">
            Online
          </div>
        </div>
      </div>
      <button class="close-btn" id="close-chat">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="chat-body" id="chat-body">
      <!-- Messages will be added here dynamically -->
    </div>

    <div class="chat-actions">
      <a href="https://wa.me/6281262465409?text=Halo%20Trio%20Agus%2C%20saya%20tertarik%20dengan%20jasa%20pembuatan%20website%20Anda"
        class="action-btn btn-primary" target="_blank">
        <i class="fab fa-whatsapp"></i>
        Lanjut ke WhatsApp
      </a>
      <button class="action-btn btn-secondary" id="close-chat-btn">
        <i class="fas fa-times"></i>
        Tutup
      </button>
    </div>
  </div>
</div>

<style>
  #floating-whatsapp {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
    animation: float 3s ease-in-out infinite;
  }

  @keyframes float {
    0%, 100% {
      transform: translateY(0px);
    }
    50% {
      transform: translateY(-10px);
    }
  }

  #wa-button {
    display: flex;
    align-items: center;
    background: #25d366;
    color: white;
    padding: 15px 20px;
    border-radius: 50px;
    text-decoration: none;
    box-shadow: 0 4px 20px rgba(37, 211, 102, 0.3);
    transition: all 0.3s ease;
    animation: pulse-green 2s infinite;
  }

  #wa-button:hover {
    background: #20c55a;
    transform: scale(1.05);
    box-shadow: 0 6px 25px rgba(37, 211, 102, 0.4);
  }

  @keyframes pulse-green {
    0% {
      box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7);
    }
    70% {
      box-shadow: 0 0 0 10px rgba(37, 211, 102, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(37, 211, 102, 0);
    }
  }

  .wa-icon {
    font-size: 28px;
    margin-right: 10px;
  }

  .wa-text {
    font-weight: 600;
    font-size: 16px;
  }

  .notification-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #ff4444;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.2);
    }
    100% {
      transform: scale(1);
    }
  }

  /* Chat Bubble Styles */
  .chat-bubble {
    position: absolute;
    bottom: 80px;
    right: 0;
    width: 320px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    transform: scale(0) translateY(20px);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    transform-origin: bottom right;
  }

  .chat-bubble.active {
    transform: scale(1) translateY(0);
    opacity: 1;
  }

  .chat-header {
    background: #25d366;
    color: white;
    padding: 15px 20px;
    border-radius: 20px 20px 0 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .chat-info {
    display: flex;
    align-items: center;
  }

  .chat-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #20c55a;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 18px;
  }

  .chat-details h4 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
  }

  .chat-status {
    font-size: 12px;
    opacity: 0.9;
    margin-top: 2px;
  }

  .close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    transition: background 0.3s;
  }

  .close-btn:hover {
    background: rgba(255,255,255,0.1);
  }

  .chat-body {
    padding: 20px;
    max-height: 300px;
    overflow-y: auto;
  }

  .message {
    margin-bottom: 15px;
    animation: messageSlide 0.5s ease-out;
  }

  @keyframes messageSlide {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .message-bubble {
    background: #dcf8c6;
    /* warna hijau WA */
    padding: 12px 16px;
    border-radius: 18px 18px 0 18px;
    /* bubble style WA */
    max-width: 85%;
    word-wrap: break-word;
    line-height: 1.4;
    color: #111;
    font-size: 14px;
    position: relative;
    box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
  }

.message.user .message-bubble {
Â  background: #fff;
Â  border-radius: 18px 18px 18px 0;
Â  align-self: flex-end;
}



  .message-time {
    font-size: 11px;
    color: #888;
    margin-top: 5px;
  }

  .typing-indicator {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
  }

  .typing-bubble {
    background: #f0f0f0;
    padding: 12px 16px;
    border-radius: 18px 18px 18px 6px;
    display: flex;
    align-items: center;
  }

  .typing-dots {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #999;
    animation: typing 1.4s infinite;
  }

  .dot:nth-child(1) {
    animation-delay: 0s;
  }
  .dot:nth-child(2) {
    animation-delay: 0.2s;
  }
  .dot:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes typing {
    0%, 60%, 100% {
      transform: scale(1);
      opacity: 0.5;
    }
    30% {
      transform: scale(1.2);
      opacity: 1;
    }
  }

  .typing-text {
    margin-left: 10px;
    font-size: 12px;
    color: #888;
    font-style: italic;
  }

  .chat-actions {
    padding: 15px 20px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 10px;
  }

  .action-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-primary {
    background: #25d366;
    color: white;
  }

  .btn-primary:hover {
    background: #20c55a;
    transform: translateY(-2px);
  }

  .btn-secondary {
    background: #f5f5f5;
    color: #333;
  }

  .btn-secondary:hover {
    background: #e0e0e0;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    #floating-whatsapp {
      bottom: 20px;
      right: 20px;
    }

    .chat-bubble {
      width: 280px;
    }

    .wa-text {
      display: none;
    }

    .wa-icon {
      margin-right: 0;
    }
  }
</style>

<script>
  class WhatsAppChat {
    constructor() {
      this.chatBubble = document.getElementById('chat-bubble');
      this.chatBody = document.getElementById('chat-body');
      this.chatStatus = document.getElementById('chat-status');
      this.waButton = document.getElementById('wa-button');
      this.closeBtn = document.getElementById('close-chat');
      this.closeChatBtn = document.getElementById('close-chat-btn');
      this.notificationBadge = document.querySelector('.notification-badge');

      this.messages = [{
        text: "Halo! ðŸ‘‹ Sedang cari jasa pembuatan website?",
        delay: 1200
      },
        {
          text: "Saya menyediakan layanan pembuatan website secara profesional, bisa disesuaikan dengan kebutuhan Anda.",
          delay: 1800
        },
        {
          text: "Cocok untuk bisnis kecil, personal branding, portofolio, atau toko online.",
          delay: 2500
        },
        {
          text: "Silakan hubungi saya jika ada pertanyaan atau ingin berdiskusi lebih lanjut. Saya siap bantu ðŸ˜Š",
          delay: 3200
        }];



      this.currentMessageIndex = 0;
      this.isOpen = false;

      this.init();
    }

    init() {
      this.waButton.addEventListener('click', (e) => {
        e.preventDefault();
        this.toggleChat();
      });

      this.closeBtn.addEventListener('click', () => {
        this.closeChat();
      });

      this.closeChatBtn.addEventListener('click', () => {
        this.closeChat();
      });

      // Close chat when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#floating-whatsapp') && this.isOpen) {
          this.closeChat();
        }
      });

      // Scroll effect
      this.handleScroll();
    }

    toggleChat() {
      if (this.isOpen) {
        this.closeChat();
      } else {
        this.openChat();
      }
    }

    openChat() {
      this.isOpen = true;
      this.chatBubble.classList.add('active');
      this.notificationBadge.style.display = 'none';
      this.chatBody.innerHTML = '';
      this.currentMessageIndex = 0;
      this.chatStatus.textContent = 'Mengetik...';

      // Start showing messages
      this.showNextMessage();
    }

    closeChat() {
      this.isOpen = false;
      this.chatBubble.classList.remove('active');
      this.notificationBadge.style.display = 'flex';
      this.chatStatus.textContent = 'Online';
    }

    showNextMessage() {
      if (this.currentMessageIndex < this.messages.length) {
        const message = this.messages[this.currentMessageIndex];

        // Show typing indicator
        this.showTypingIndicator();

        setTimeout(() => {
          this.hideTypingIndicator();
          this.addMessage(message.text);
          this.currentMessageIndex++;

          // Show next message if available
          if (this.currentMessageIndex < this.messages.length) {
            setTimeout(() => {
              this.showNextMessage();
            }, 800);
          } else {
            this.chatStatus.textContent = 'Online';
          }
        },
          message.delay);
      } else {
        this.chatStatus.textContent = 'Online';
      }
    }

    showTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing-indicator';
      typingDiv.id = 'typing-indicator';

      typingDiv.innerHTML = `
      <div class="typing-bubble">
      <div class="typing-dots">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
      </div>
      <div class="typing-text">Trio Agus sedang mengetik...</div>
      </div>
      `;

      this.chatBody.appendChild(typingDiv);
      this.scrollToBottom();
    }

    hideTypingIndicator() {
      const typingIndicator = document.getElementById('typing-indicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    addMessage(text) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';

      const now = new Date();
      const time = now.toLocaleTimeString('id-ID', {
        hour: '2-digit',
        minute: '2-digit'
      });

      messageDiv.innerHTML = `
      <div class="message-bubble">
      ${text.replace(/\n/g, '<br>')}
      <div class="message-time">${time}</div>
      </div>
      `;

      this.chatBody.appendChild(messageDiv);
      this.scrollToBottom();
    }

    scrollToBottom() {
      this.chatBody.scrollTop = this.chatBody.scrollHeight;
    }

    handleScroll() {
      let lastScrollTop = 0;
      const floatingWa = document.getElementById('floating-whatsapp');

      window.addEventListener('scroll', () => {
        const st = window.pageYOffset || document.documentElement.scrollTop;

        if (st > lastScrollTop && st > 200) {
          // Scrolling down
          floatingWa.style.transform = 'translateY(100px)';
          floatingWa.style.opacity = '0.7';
        } else {
          // Scrolling up
          floatingWa.style.transform = 'translateY(0)';
          floatingWa.style.opacity = '1';
        }

        lastScrollTop = st <= 0 ? 0: st;
      });
    }
  }

  // Initialize when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    new WhatsAppChat();
  });
</script>